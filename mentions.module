<?php 

/**
 * @file mentions.module
 */

use Drupal\Core\Url;

/**
 * Provides hook implementations for mentions module.
 */
function mentions_theme() {
  return array('mentions' => array('render element' => 'userintext'));
}

/**
 * Implements template_preprocess_mentions().
 */
function template_preprocess_mentions(&$variables) {
  $settings = \Drupal::config('mentions.mentions');
  $output_settings = $settings->get('output');
  $user = $variables['userintext']['#user'];

  global $base_url;
  global $base_root;
  foreach (array('text', 'link') as $type) {
    if (!empty($output_settings[$type])) {
      $content = \Drupal::token()->replace($output_settings[$type], array('user' => $user));
      if ($type == 'text') {
        $text = $content;
      }
      else {
        $link = htmlentities($content);
      }
    }
  }

  $user_page_url = Url::fromUri('base:' . $link);
  $variables['userid'] = $user->id();
  $variables['link'] = \Drupal::l($output_settings['prefix'] . $text . $output_settings['suffix'], $user_page_url, array('attributes' => array('class' => 'mentions mentions-' . $user->id(), 'title' => $text)))->getGeneratedLink();
}
